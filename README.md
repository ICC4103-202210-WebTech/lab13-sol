# Solution to Lab Assignment #11

## Introduction

In this lab assignment, you will continue to add some features to the Ticket Shop, requiring DOM manipulation and asynchronous (ajax) calls to you application. Specifically, you will add an asynchronous delete feature to the list of orders, and an event search interface.

You may continue to work in pairs.

## Pre-requisites

To get started, you will need to be familiar with the following topics covered in slide decks 9 and 10:

1. The HTML DOM, and its APIs, such as events, and traversal.
2. The basics of ECMAScript (ES6), including function expressions, IIFEs, the console.
3. Data attributes in HTML 5. For this, you can see the first few slides of class 10, wherein this is explained.
4. The Fetch API for asynchronous calls to your application. 

## Run the First Steps as Usual

If you use RVM then the correct version of ruby and gemset will be chosen automatically for you (`3.1.1@webtech`)
whenever you switch to the project directory on the terminal. If you need to choose this manually, then run

```sh
$rvm use 3@webtech
```

Install any missing gems and setup de database:

```sh
bundle install # new gems have been added to the Gemfile
rails db:setup
rails db:populate_fake_data # This will generate fake events, customers, etc.
rails s # Run the application with an application server
```

Note that the last command will launch an application server that will allow accessing your application from either a web browser (at [http://localhost:3000](http://localhost:3000)).

## Non-graded Steps

1. Take a look at the solution of lab 10, available in this starter code for lab 11. See how the event handler is defined for each of the sort buttons in `app/javascripts/custom/events.js`.
2. Also, take a look at `app/javascripts/custom/events.js`, wherein an event listener is attached to each delete button that is dynamically created and injected into the DOM whenever new form fields for an additional `TicketType` resource are created.

## Let's roll

1. [1.0 point] Go to `app/views/orders/index.html.erb` and add a rightmost column to the table displaying the orders. For each order, display a delete button (use Bootstrap `btn` `btn-danger` button classes). 
2. [1.0 point] When a delete button is pressed, a confirmation dialog must be presented to the user. If the user cancels, nothing happens. If the user accepts, the target order must be deleted asynchronously. Implement this as explained in section 5.2 of [this guide](https://edgeguides.rubyonrails.org/working_with_javascript_in_rails.html#confirmations).
3. [1.0 point] Feedback must be displayed telling that the order was successfully deleted, or if there was an error. Check out the divs with `notice` and `alert` IDs in the `application.html.erb` layout. You should use these divs if they are available, or create a new div programmatically to display the feedback to the user. Set a timer that destroys the div after three seconds being displayed. Complete the event handlers in `app/javascript/packs/orders.js` in order to 
accomplish this.
4. [1.0 point] Create a blank controller called `SearchController` that inherits from `ApplicationController`. Add the `search` action to this controller. Create a non-resourceful route that responds to both `GET` and `POST` verbs that responds to `/search` and maps to `SearchController#search`.
5. [1.0 point] Implement the `SearchController#search` method. This method must search for events in which the name or the description matches the given keywords. Use the `where` method in Active Record together with the `like` keyword  in the query to find matches, like it is done with plain SQL. This action must render the 
`app/views/search/search.html.erb` view, containing a list with the matching events (i.e., note the use of the `@events` variable in that template. This is where you must put the search results in `SearchController#search`).
6. [1.0 point] Complete the `app/javascript/search.js` script, so that (1) the search button handler triggers a `fetch()` call to your application requesting search results using whatever text is in the search box as search parameter. (2) The results generated by `SearchController#search` are rendered as HTML by Rails. You must hide the `main-content` `main` element in the page (set the property `style.display` to `"none"`), then, take the result obtained from the  call to `fetch()`, create a new `main` element, set its `innerHTML` property to the result obtained by `fetch()`. See [this example](https://developer.mozilla.org/en-US/docs/Web/API/Body/text) to understand how to work with the text that is obtained by `fetch()`. (3) If the search box is cleared, the `main` element with search results must be destroyed, and the original `main` element must have its `style.display` property restored to `"block"` in order to be visible again.

With the above steps, your TicketShop will permit the user searching for events, and deleting orders. 

## Grading

Each of the four parts of the assignment will be graded on a scale from 1 to 5. The criteria for each score is as follows:

* Not implemented.
* Some very basic implementation is attempted, or the implementation is fundamentally flawed.
* The implementation is either incomplete, does not follow conventions or it is flawed to a considerable extent.
* The implementation is rather complete, but there are issues.
* The implementation is complete and correct.

Then each 1-5 score will translate to 0, 0.25, 0.5, 0.75 and 1.0 weights that will multiply the maximum score possible in the corresponding part of the assignment. The weighted scores will be added up with the base point to calculate the final grade on a scale from 1 to 7.

## Active Record reference

We leave the following sections from previous lab assignments here, in case you need to perform operations with Active Record, for any reason.

## About migrations

* Migrations that you create by using the rails generator can be modified by hand. You may do so in case you misstype column names, or types. If you need to modify a migration by hand, delete the database (run `db:drop`) (see below about database tasks), and start over recreating the database (run `db:setup`).

## The Rails Console

Ruby on Rails provides a console on which you may run ruby code that instances the models contained in your application, and allows you to try out the associations that are implemented. Just to give you an idea about what is possible, consider the following example:

```sh
rails c
> Event.all # Will show all Beer models available
> Event.first # Will show the first event record found
> ev = EventVenue.create(name: bb, capacity: 1000) # Create an event venue
> e = Event.create(...) # This will create an event
> c = Customer.create(...)
```

To quit the console, press Ctrl+D.

## Basic database tasks

Rails provides several database tasks that you may run on the command line whenever needed:

* `db:migrate` runs (single) migrations that have not run yet.
* `db:create` creates the database
* `db:drop` deletes the database
* `db:schema:load` creates tables and columns within the (existing) database following `schema.rb`
* `db:setup` does `db:create`, `db:schema:load`,  `db:seed`
* `db:reset` does `db:drop`, `db:setup`

Typically, you would use db:migrate after having made changes to the schema via new migration files (this makes sense only if there is already data in the database). `db:schema:load` is used when you setup a new instance of your app.

After you create a migration, do not forget to apply it to the database!

```sh
rails db:migrate
```

The following example will drop the current database and then recreate it, including initialization as specified in `db/seeds.rb`:

```sh
rails db:drop
rails db:setup
```

## Useful links

The following links to Rails Guides will provide you useful information for completing your assignment:

* [Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)
* [Document Object Model](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model)
* [The HTML DOM API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API)
* [HTML 5 basics (W3Schools)](https://www.w3schools.com/html/html_basic.asp)
* [Layouts and Rendering in Rails](https://edgeguides.rubyonrails.org/layouts_and_rendering.html)
* [Action View Helpers](https://edgeguides.rubyonrails.org/form_helpers.html) 
* [Rails Action Controller Overview](https://edgeguides.rubyonrails.org/action_controller_overview.html) 
* [Rails Routing from the Outside In](https://edgeguides.rubyonrails.org/routing.html)
* [Command line](http://edgeguides.rubyonrails.org/command_line.html)
* [Active Record Basics](http://edgeguides.rubyonrails.org/active_record_basics.html)
* [Active Record Model](http://api.rubyonrails.org/classes/ActiveModel/Model.html)
* [Basic Models Associations](http://edgeguides.rubyonrails.org/association_basics.html)
* [Active Record Association Methods](http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html)
* [Active Record Migrations](http://edgeguides.rubyonrails.org/active_record_migrations.html)
* [Active Record Validations](https://edgeguides.rubyonrails.org/active_record_validations.html)
* [Active Record Query Interface](https://edgeguides.rubyonrails.org/active_record_callbacks.html)
